<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.18); }
        h1 { text-align: center; color: #333; margin-bottom: 18px; font-size: 24px; }
        .section { margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; }
        .section-title { font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 12px; }
        .form-group { margin-bottom: 14px; }
        label { display: block; margin-bottom: 6px; color: #555; font-weight: 500; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: #667eea; }
        .input-with-unit { position: relative; }
        .input-with-unit input { padding-right: 64px; }
        .input-with-unit::after { content: '‡∏ö‡∏≤‡∏ó'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; pointer-events: none; font-size: 14px; }
        .employee-card { background: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; border: 2px solid #e9eefc; position: relative; }
        .employee-header { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
        .employee-name-input { flex: 1; }
        .employee-fields { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .employee-field-label { font-size: 13px; color: #666; margin-bottom: 6px; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.18s; min-height: 44px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(102,126,234,0.28); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-add { background: #17a2b8; color: white; width: 100%; padding: 10px; }
        .btn-danger { background: #dc3545; color: white; padding: 0; width: 36px; height: 36px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:18px; }
        .button-group { display:flex; gap:12px; margin-top: 18px; flex-wrap: wrap; align-items:center; }
        .button-group .btn { flex:1; min-width: 140px; }
        .result-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 18px; border-radius: 12px; margin-top: 20px; color: white; }
        .result-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom: 1px solid rgba(255,255,255,0.18); }
        .result-item:last-child { border-bottom: none; }
        .profit-per-person { background: rgba(255,255,255,0.12); padding:12px; border-radius:8px; margin-top:12px; }
        .date-selector { display:grid; grid-template-columns: 2fr 1fr 1fr; gap:8px; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 12px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .profit-names-section { background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 12px; }
        .profit-name-row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
        .profit-name-row input { flex: 1; padding: 8px 10px; }
        @media (max-width: 600px) {
            .date-selector { grid-template-columns: 1fr; }
            .employee-fields { grid-template-columns: 1fr; }
            .button-group { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container" id="pageRoot">
        <h1>üè™ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡πâ‡∏≤‡∏ô</h1>

        <div id="alertBox" style="display:none;" class="alert"></div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö -->
        <div class="section">
            <div class="section-title">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                <div class="input-with-unit">
                    <input type="text" id="income" inputmode="decimal" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç" class="num-input">
                </div>
            </div>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ -->
        <div class="section">
            <div class="section-title">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
            
            <div class="form-group">
                <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</label>
                <div class="input-with-unit">
                    <!-- ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 61102 ‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ -->
                    <input type="text" id="rent" inputmode="decimal" class="num-input" value="61102">
                </div>
            </div>

            <!-- ‡∏Ñ‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
            <div class="form-group">
                <label>‡∏Ñ‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° + ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</label>
                <div id="employeeList"></div>
                <button class="btn btn-add" type="button" onclick="addEmployee()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
            </div>

            <div class="form-group">
                <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï wifi</label>
                <div class="input-with-unit">
                    <input type="text" id="wifi" inputmode="decimal" class="num-input">
                </div>
            </div>

            <div class="form-group">
                <label>‡∏ï‡∏≥‡∏£‡∏ß‡∏à</label>
                <div class="input-with-unit">
                    <input type="text" id="police" inputmode="decimal" class="num-input">
                </div>
            </div>

            <div class="form-group">
                <label>‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</label>
                <div class="input-with-unit">
                    <input type="text" id="supplies" inputmode="decimal" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç" class="num-input">
                </div>
            </div>

            <div class="form-group">
                <label>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                <div class="input-with-unit">
                    <input type="text" id="other" inputmode="decimal" placeholder="0" class="num-input">
                </div>
            </div>
        </div>

        <!-- ‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£ -->
        <div class="section">
            <div class="section-title">‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£</div>
            
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô)</label>
                <div class="date-selector">
                    <select id="month"> 
                        <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                        <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                        <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                        <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                        <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                        <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                        <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                        <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                        <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                        <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                        <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                    </select>
                    <input type="number" id="year" value="" />
                    <input type="number" id="daysInMonth" value="31" min="1" max="31" />
                </div>
                <small style="color:#666; display:block; margin-top:6px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</small>
            </div>

            <div class="profit-names-section">
                <label style="margin-bottom: 10px; display:block;">‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£</label>
                <div id="profitNamesList"></div>
                <button class="btn btn-add" type="button" onclick="addProfitPerson()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô</button>
            </div>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
        <div class="button-group">
            <button class="btn btn-primary" type="button" onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
            <button class="btn btn-secondary" type="button" onclick="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>

            <!-- export controls: default target = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤, user can choose pdf/jpg -->
            <div style="display:flex; gap:8px; align-items:center; margin-left:8px;">
              <select id="exportFormat" style="padding:8px 10px; border-radius:8px;">
                <option value="pdf">PDF</option>
                <option value="jpg">JPG</option>
              </select>

              <button id="exportBtn" class="btn btn-primary" type="button">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
            </div>
        </div>

        <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
        <div class="result-box" id="resultBox" style="display:none;">
            <div class="result-item">
                <span class="result-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                <span class="result-value" id="resultIncome">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢:</span>
                <span class="result-value" id="resultExpense">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="result-item">
                <span class="result-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                <span class="result-value" id="resultProfit">0.00 ‡∏ö‡∏≤‡∏ó</span>
            </div>
            <div class="profit-per-person" id="profitPerPerson"></div>
        </div>
    </div>

    <!-- libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        /* --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö --- */
        function formatMoneyDisplay(value) {
            if (value === '' || value === null || isNaN(Number(value))) return '';
            const num = Number(value);
            return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function unformat(value) {
            if (value === undefined || value === null) return '';
            return value.toString().replace(/,/g, '').trim();
        }

        // ‡∏ú‡∏π‡∏Å‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÉ‡∏´‡πâ input ‡∏ó‡∏µ‡πà‡∏°‡∏µ class .num-input
        function attachNumericFormatting(input) {
    if (!input) return;

    // on focus: ‡πÄ‡∏≠‡∏≤ comma ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡∏á‡πà‡∏≤‡∏¢
    input.addEventListener('focus', (e) => {
        const raw = unformat(e.target.value);
        e.target.value = raw === '' ? '' : raw;
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏ß‡πâ (best-effort)
        try { const pos = e.target.selectionStart; e.target.dataset.caret = pos; } catch (err) {}
    });

    // on blur: ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á + comma (‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)
    input.addEventListener('blur', (e) => {
        const raw = unformat(e.target.value);
        if (raw === '') {
            // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ)
            e.target.value = '';
            return;
        }
        // ‡πÄ‡∏≠‡∏≤ comma ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Number
        const normalized = raw.replace(/,/g, '');
        const n = Number(normalized);
        if (isNaN(n)) {
            e.target.value = '';
        } else {
            // formatMoneyDisplay ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ minimumFractionDigits:2 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
            e.target.value = formatMoneyDisplay(n);
        }
    });

    // on input: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ (‡πÅ‡∏ï‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï comma/dot) ‚Äî ‡πÑ‡∏°‡πà‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    input.addEventListener('input', (e) => {
        const cleaned = e.target.value.replace(/[^\d\.,-]/g, '');
        if (cleaned !== e.target.value) e.target.value = cleaned;
    });
}

        /* --- Helpers --- */
        function parseNumberFromInput(el) {
            if (!el) return NaN;
            const v = el.value || '';
            const raw = v.toString().replace(/,/g, '').trim();
            if (raw === '') return NaN;
            const n = Number(raw);
            return isNaN(n) ? NaN : n;
        }

        function showAlert(message, type='error') {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.style.display = 'block';
            if (type === 'success') {
                alertBox.style.background = '#d4edda';
                alertBox.style.color = '#155724';
                alertBox.style.borderColor = '#c3e6cb';
            } else {
                alertBox.style.background = '#f8d7da';
                alertBox.style.color = '#721c24';
                alertBox.style.borderColor = '#f5c6cb';
            }
            setTimeout(hideAlert, 2500);
        }
        function hideAlert() { document.getElementById('alertBox').style.display = 'none'; }

        /* --- Employee management --- */
        let employeeCount = 0;
        function addEmployee(name = '', salary = 12000, commission = '', holiday = '', isInitial = false) {
            const employeeList = document.getElementById('employeeList');

            const card = document.createElement('div');
            card.className = 'employee-card';
            card.dataset.index = employeeCount;

            // header
            const header = document.createElement('div');
            header.className = 'employee-header';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = '‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
            nameInput.value = name || '';
            nameInput.className = 'employee-name-input';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn-danger';
            removeBtn.title = '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
            removeBtn.textContent = '√ó';
            removeBtn.addEventListener('click', () => {
                const cards = document.querySelectorAll('.employee-card');
                if (cards.length <= 1) {
                    showAlert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');
                    return;
                }
                card.remove();
            });

            header.appendChild(nameInput);
            header.appendChild(removeBtn);

            // fields
            const fields = document.createElement('div');
            fields.className = 'employee-fields';

            // ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const col1 = document.createElement('div');
            const lbl1 = document.createElement('div'); lbl1.className='employee-field-label'; lbl1.textContent='‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            const wrap1 = document.createElement('div'); wrap1.className='input-with-unit';
            const salaryInput = document.createElement('input');
            salaryInput.type = 'text';
            salaryInput.inputMode = 'decimal';
            salaryInput.className = 'employee-salary num-input';
            salaryInput.value = (salary !== '' && salary !== null) ? formatMoneyDisplay(salary) : '';
            wrap1.appendChild(salaryInput);
            col1.appendChild(lbl1); col1.appendChild(wrap1);

            // ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ)
            const col2 = document.createElement('div');
            const lbl2 = document.createElement('div'); lbl2.className='employee-field-label'; lbl2.textContent='‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°';
            const wrap2 = document.createElement('div'); wrap2.className='input-with-unit';
            const commissionInput = document.createElement('input');
            commissionInput.type = 'text';
            commissionInput.inputMode = 'decimal';
            commissionInput.className = 'employee-commission num-input';
            commissionInput.placeholder = '(‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)';
            commissionInput.value = (commission !== '' && commission !== null) ? formatMoneyDisplay(commission) : '';
            wrap2.appendChild(commissionInput);
            col2.appendChild(lbl2); col2.appendChild(wrap2);

            // ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ)
            const col3 = document.createElement('div');
            const lbl3 = document.createElement('div'); lbl3.className='employee-field-label'; lbl3.textContent='‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î';
            const wrap3 = document.createElement('div'); wrap3.className='input-with-unit';
            const holidayInput = document.createElement('input');
            holidayInput.type = 'text';
            holidayInput.inputMode = 'decimal';
            holidayInput.className = 'employee-holiday num-input';
            holidayInput.placeholder = '(‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)';
            holidayInput.value = (holiday !== '' && holiday !== null) ? formatMoneyDisplay(holiday) : '';
            wrap3.appendChild(holidayInput);
            col3.appendChild(lbl3); col3.appendChild(wrap3);

            fields.appendChild(col1);
            fields.appendChild(col2);
            fields.appendChild(col3);

            card.appendChild(header);
            card.appendChild(fields);
            employeeList.appendChild(card);

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (isInitial) ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ)
            if (isInitial || document.querySelectorAll('.employee-card').length === 1) {
                removeBtn.disabled = true;
                removeBtn.style.opacity = '0.5';
                removeBtn.title = '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ';
            } else {
                removeBtn.disabled = false;
                removeBtn.style.opacity = '1';
                removeBtn.title = '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô';
            }

            // Attach numeric formatting handlers
            card.querySelectorAll('.num-input').forEach(attachNumericFormatting);

            employeeCount++;
        }

        /* --- Profit persons --- */
        let profitPersonCount = 0;
        function addProfitPerson(defaultName = '') {
            const list = document.getElementById('profitNamesList');
            const row = document.createElement('div');
            row.className = 'profit-name-row';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '‡∏ä‡∏∑‡πà‡∏≠';
            input.className = 'profit-person-name';
            input.value = defaultName || '';

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-danger';
            btn.textContent = '√ó';
            btn.addEventListener('click', () => {
                const names = document.querySelectorAll('.profit-person-name');
                if (names.length <= 1) {
                    showAlert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£');
                    return;
                }
                row.remove();
            });

            row.appendChild(input);
            row.appendChild(btn);
            list.appendChild(row);
            profitPersonCount++;
        }

        /* --- ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏ß‡∏±‡∏ô --- */
        function setCurrentMonthYear() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const year = now.getFullYear() + 543; // ‡∏û.‡∏®.
            document.getElementById('month').value = month;
            document.getElementById('year').value = year;
        }
        function updateDaysInMonth() {
            const month = parseInt(document.getElementById('month').value) || 1;
            let year = parseInt(document.getElementById('year').value) || new Date().getFullYear()+543;
            if (year > 2500) year = year - 543;
            const days = new Date(year, month, 0).getDate();
            document.getElementById('daysInMonth').value = days;
        }

        /* --- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì --- */
        function calculate() {
            hideAlert();
            const incomeEl = document.getElementById('income');
            const income = parseNumberFromInput(incomeEl);
            if (isNaN(income)) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)');
                return;
            }

            const rent = parseNumberFromInput(document.getElementById('rent')) || 0;
            const wifi = parseNumberFromInput(document.getElementById('wifi')) || 0;
            const police = parseNumberFromInput(document.getElementById('police')) || 0;
            const supplies = parseNumberFromInput(document.getElementById('supplies')) || 0;
            const other = parseNumberFromInput(document.getElementById('other')) || 0;

            // ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            let totalEmployeeCost = 0;
            const cards = document.querySelectorAll('.employee-card');
            cards.forEach(card => {
                const sal = parseNumberFromInput(card.querySelector('.employee-salary')) || 0;
                const com = parseNumberFromInput(card.querySelector('.employee-commission')) || 0;
                const hol = parseNumberFromInput(card.querySelector('.employee-holiday')) || 0;
                totalEmployeeCost += sal + com + hol;
            });

            const totalExpense = rent + totalEmployeeCost + wifi + police + supplies + other;
            const profit = income - totalExpense;

            // ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£
            const profitPersonNames = Array.from(document.querySelectorAll('.profit-person-name'))
                .map(i => i.value.trim())
                .filter(n => n !== '');

            if (profitPersonNames.length === 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô');
                return;
            }

            const numPeople = profitPersonNames.length;
            const daysInMonth = parseInt(document.getElementById('daysInMonth').value) || 30;

            const profitPerPerson = profit / numPeople;
            const profitPerDay = profitPerPerson / daysInMonth;

            document.getElementById('resultIncome').textContent = formatMoneyDisplay(income) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('resultExpense').textContent = formatMoneyDisplay(totalExpense) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('resultProfit').textContent = formatMoneyDisplay(profit) + ' ‡∏ö‡∏≤‡∏ó';

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£
            const perBox = document.getElementById('profitPerPerson');
            perBox.innerHTML = `<div style="font-weight:bold; margin-bottom:8px;">‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô (${daysInMonth} ‡∏ß‡∏±‡∏ô):</div>`;
            profitPersonNames.forEach(name => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'space-between';
                row.style.padding = '6px 0';
                const left = document.createElement('div'); left.textContent = name + ':';
                const right = document.createElement('div'); right.textContent = `${formatMoneyDisplay(profitPerPerson)} ‡∏ö‡∏≤‡∏ó (‡∏ß‡∏±‡∏ô‡∏•‡∏∞ ${formatMoneyDisplay(profitPerDay)} ‡∏ö‡∏≤‡∏ó)`;
                row.appendChild(left); row.appendChild(right);
                perBox.appendChild(row);
            });

            document.getElementById('resultBox').style.display = 'block';
            // scroll to result
            document.getElementById('resultBox').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            hideAlert();
            document.getElementById('income').value = '';
            // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ default ‡πÄ‡∏õ‡πá‡∏ô 61102 (‡πÅ‡∏ï‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)
            document.getElementById('rent').value = formatMoneyDisplay(61102);
            document.getElementById('wifi').value = formatMoneyDisplay(641);
            document.getElementById('police').value = formatMoneyDisplay(500);
            document.getElementById('supplies').value = ''; // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏° request
            document.getElementById('other').value = formatMoneyDisplay(0);

            // employees
            document.getElementById('employeeList').innerHTML = '';
            employeeCount = 0;
            addEmployee('‡πÅ‡∏Å‡πâ‡∏ß', 12000, '', '', true);

            // profit names
            document.getElementById('profitNamesList').innerHTML = '';
            profitPersonCount = 0;
            addProfitPerson('‡∏ó‡∏±‡∏®‡∏ô‡πå');
            addProfitPerson('‡∏£‡∏∏‡πà‡∏á');
            addProfitPerson('‡∏ô‡∏≤‡∏¢');

            document.getElementById('resultBox').style.display = 'none';

            setCurrentMonthYear();
            updateDaysInMonth();

            // attach formatting to main inputs
            document.querySelectorAll('.num-input').forEach(attachNumericFormatting);
        }

        /* --- Export helpers: clone + replace inputs for reliable capture --- */
        function createCaptureClone(element) {
            // clone node and replace form controls with plain divs that keep the visible value and styles
            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.left = '-10000px';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '9999';

            const clone = element.cloneNode(true);

            const originals = element.querySelectorAll('input, textarea, select');
            const clones = clone.querySelectorAll('input, textarea, select');

            // utility to copy a subset of computed styles
            function copyStylesTo(elOut, computed) {
                const props = ['width','height','padding-top','padding-right','padding-bottom','padding-left','font-size','font-family','font-weight','line-height','color','background-color','border','border-radius','box-sizing','text-align'];
                props.forEach(p => {
                    try {
                        const v = computed.getPropertyValue(p);
                        if (v) elOut.style.setProperty(p, v);
                    } catch (e) {}
                });
                elOut.style.display = 'inline-block';
                elOut.style.whiteSpace = 'pre-wrap';
                elOut.style.overflowWrap = 'break-word';
            }

            clones.forEach((c,i) => {
                const orig = originals[i];
                let value = '';
                if (!orig) return; // safety
                if (orig.tagName.toLowerCase() === 'select') {
                    value = orig.options[orig.selectedIndex] ? orig.options[orig.selectedIndex].text : '';
                } else {
                    value = orig.value || '';
                }

                const display = document.createElement('div');
                display.textContent = value;

                const computed = window.getComputedStyle(orig);
                copyStylesTo(display, computed);

                // ensure readable colors on white background
                if (!display.style['background-color'] || display.style['background-color'] === 'transparent') {
                    display.style['background-color'] = '#ffffff';
                }
                if (!display.style.color) display.style.color = '#000000';

                // replace clone control with plain div
                c.parentNode && c.parentNode.replaceChild(display, c);
            });

            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);
            return wrapper;
        }

        async function generateCanvasFor(element) {
            // create a temporary clone where inputs are replaced by plain text DIVs (so html2canvas renders values clearly)
            const clonedWrapper = createCaptureClone(element);
            // pick the cloned element inside wrapper
            const clonedElement = clonedWrapper.firstElementChild;
            // scale 2 for sharper result
            const canvas = await html2canvas(clonedElement, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
            // remove temporary clone
            clonedWrapper.remove();
            return canvas;
        }

        /* --- Export (single long page PDF / JPG) --- */
        async function exportToPDF(element, filename = 'export.pdf') {
            const canvas = await generateCanvasFor(element);
            const imgData = canvas.toDataURL('image/png');

            const { jsPDF } = window.jspdf || {};
            // create single-page PDF sized exactly to the canvas (use px unit)
            try {
                const pdf = new jsPDF({ unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(filename);
            } catch (e) {
                // fallback: convert to A4 with splitting if jsPDF doesn't support px unit
                const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pxToPt = pdfWidth / canvas.width;
                const fullHeightPt = canvas.height * pxToPt;
                if (fullHeightPt <= pdf.internal.pageSize.getHeight()) {
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, fullHeightPt);
                    pdf.save(filename);
                } else {
                    const sliceHeightPx = Math.floor(pdf.internal.pageSize.getHeight() / pxToPt);
                    let y = 0;
                    while (y < canvas.height) {
                        const h = Math.min(sliceHeightPx, canvas.height - y);
                        const tmpCanvas = document.createElement('canvas');
                        tmpCanvas.width = canvas.width;
                        tmpCanvas.height = h;
                        tmpCanvas.getContext('2d').drawImage(canvas, 0, y, canvas.width, h, 0, 0, canvas.width, h);
                        const tmpData = tmpCanvas.toDataURL('image/png');
                        const hPt = h * pxToPt;
                        pdf.addImage(tmpData, 'PNG', 0, 0, pdfWidth, hPt);
                        y += h;
                        if (y < canvas.height) pdf.addPage();
                    }
                    pdf.save(filename);
                }
            }
        }

        async function exportToJPG(element, filename = 'export.jpg') {
            const canvas = await generateCanvasFor(element);
            const data = canvas.toDataURL('image/jpeg', 0.95);
            const link = document.createElement('a');
            link.href = data;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const exportBtn = document.getElementById('exportBtn');
            if (!exportBtn) return;

            exportBtn.addEventListener('click', async () => {
                // default target = entire page container
                const target = 'page';
                const format = document.getElementById('exportFormat').value;
                const element = document.getElementById('pageRoot');

                try {
                    showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'success');
                    const now = new Date();
                    const ts = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                    const filename = `${target}_${ts}.${format}`;

                    if (format === 'pdf') {
                        await exportToPDF(element, filename);
                    } else {
                        await exportToJPG(element, filename);
                    }
                    showAlert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch (err) {
                    console.error(err);
                    showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå', 'error');
                }
            });
        });

        /* --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤ --- */
        window.onload = function() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÅ‡∏Å‡πâ‡∏ß 12,000 (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏°‡∏µ‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å)
            addEmployee('‡πÅ‡∏Å‡πâ‡∏ß', 12000, '', '', true);

            // ‡∏Ñ‡πà‡∏≤ wifi/police default (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï)
            document.getElementById('wifi').value = formatMoneyDisplay(641);
            document.getElementById('police').value = formatMoneyDisplay(500);

            // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤ default ‡πÄ‡∏õ‡πá‡∏ô 61102 (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)
            const rentEl = document.getElementById('rent');
            if (rentEl && unformat(rentEl.value) === '') {
                rentEl.value = formatMoneyDisplay(61102);
            } else if (rentEl && unformat(rentEl.value) !== '') {
                rentEl.value = formatMoneyDisplay(unformat(rentEl.value));
            }

            // supplies ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏° requirement
            document.getElementById('supplies').value = '';

            // ‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ï‡∏≤‡∏° requirement
            document.getElementById('other').value = formatMoneyDisplay(0);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡πà‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            addProfitPerson('‡∏ó‡∏±‡∏®‡∏ô‡πå');
            addProfitPerson('‡∏£‡∏∏‡πà‡∏á');
            addProfitPerson('‡∏ô‡∏≤‡∏¢');

            // set ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            setCurrentMonthYear();
            updateDaysInMonth();

            // attach formatting ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å input ‡∏ó‡∏µ‡πà‡∏°‡∏µ class num-input
            document.querySelectorAll('.num-input').forEach(attachNumericFormatting);

            document.getElementById('month').addEventListener('change', updateDaysInMonth);
            document.getElementById('year').addEventListener('change', updateDaysInMonth);
        };
    </script>
</body>
</html>
